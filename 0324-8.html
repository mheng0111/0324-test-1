<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員註冊</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    .form-container { background: #fff; padding: 20px; border-radius: 10px; max-width: 600px; margin: auto; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { width: 100%; padding: 15px; background-color: #00C300; color: white; font-size: 16px; margin-top: 20px; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background-color: #999; cursor: not-allowed; }
  </style>
</head>

<body>
  <div class="form-container">
    <h2>會員註冊</h2>
    <form id="registerForm">
      <label>User ID</label>
      <input type="text" id="userId" readonly style="background-color: #e9ecef;">
      <label>姓名</label><input type="text" id="name" required>
      <label>暱稱</label><input type="text" id="nickname" required>
      <label>手機號碼</label><input type="tel" id="phone" required placeholder="09xxxxxxxx">
      <label>Email</label><input type="email" id="email" required>
      <label>生日</label><input type="date" id="birthday" required>
      <label>縣市</label><select id="city" required></select>
      <label>區域</label><select id="district" required></select>
      <label>車牌1</label><input type="text" id="plate1">
      <label>車牌2</label><input type="text" id="plate2">
      <label>車牌3</label><input type="text" id="plate3">
      <button type="submit" id="submitBtn">送出</button>
    </form>
  </div>

  <script>
    const liffId = '2007111391-g8NYprrW';
    const sheetURL = 'https://script.google.com/macros/s/AKfycbxen9S7ndTkTBrbI_CBFFwBpFxapdcfG4aPPLpIsZHpjsMJocd3ILmCHShjL5JYFT2p/exec';

    const cityDistrictMap = {
      "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區"],
      "新北市": ["板橋區", "三重區", "中和區", "永和區"],
      "台中市": ["中區", "東區", "南區", "西區", "北區"]
    };

    const citySelect = document.getElementById('city');
    const districtSelect = document.getElementById('district');
    const submitBtn = document.getElementById('submitBtn');

    function renderCityOptions() {
      citySelect.innerHTML = '<option value="">請選擇縣市</option>';
      for (const city in cityDistrictMap) {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      }
    }

    citySelect.addEventListener('change', () => {
      districtSelect.innerHTML = '<option value="">請選擇區域</option>';
      const districts = cityDistrictMap[citySelect.value];
      if (districts) {
        districts.forEach(d => {
          const option = document.createElement('option');
          option.value = d;
          option.textContent = d;
          districtSelect.appendChild(option);
        });
      }
    });

    window.onload = () => {
      renderCityOptions();
      citySelect.selectedIndex = 0;
      citySelect.dispatchEvent(new Event('change'));
    };

    async function initLiff() {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        console.log('取得 LINE Profile:', profile);
        if (profile?.userId) {
          document.getElementById('userId').value = profile.userId;
        } else {
          alert('❌ 無法取得 LINE User ID，請從 LINE 內開啟');
        }
      } catch (err) {
        console.error('LIFF 初始化失敗', err);
        alert('❌ LIFF 初始化失敗，請從 LINE 內開啟');
      }
    }
    initLiff();

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const userId = document.getElementById('userId').value;
      if (!userId) {
        alert('❌ 無法取得 LINE User ID，請從 LINE 內開啟');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '送出中...';

      const phone = document.getElementById('phone').value.trim();
      if (!/^09\d{8}$/.test(phone)) {
        alert('❌ 手機格式錯誤，請輸入正確的 09 開頭手機號碼');
        resetSubmitBtn();
        return;
      }

      const data = {
        userId: userId,
        name: document.getElementById('name').value.trim(),
        nickname: document.getElementById('nickname').value.trim(),
        phone: phone,
        email: document.getElementById('email').value.trim(),
        birthday: document.getElementById('birthday').value,
        city: citySelect.value,
        district: districtSelect.value,
        plate1: document.getElementById('plate1').value.toUpperCase().trim(),
        plate2: document.getElementById('plate2').value.toUpperCase().trim(),
        plate3: document.getElementById('plate3').value.toUpperCase().trim()
      };

      console.log('送出資料:', data);
      console.log('送出網址:', sheetURL);

      try {
        const response = await fetch(sheetURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        console.log('Response status:', response.status);

        if (!response.ok) throw new Error(`❌ 伺服器錯誤，狀態碼：${response.status}`);

        const result = await response.json();
        console.log('GAS 回傳:', result);

        if (result.message) {
          alert(result.message);
          liff.closeWindow();
        } else {
          alert('✅ 資料送出成功！');
          liff.closeWindow();
        }

      } catch (err) {
        console.error('❌ 送出失敗:', err);
        alert("❌ 送出失敗：" + err.message);
      } finally {
        resetSubmitBtn();
      }
    });

    function resetSubmitBtn() {
      submitBtn.disabled = false;
      submitBtn.textContent = '送出';
    }
  </script>
</body>

</html>

